function initialize(){var n,u=new google.maps.LatLngBounds;let t=sessionStorage.getItem("lastCenter"),i,r;t?(t=JSON.parse(urldecode(t)),i=t.center,r=t.zoom):(i={lat:37.971956,lng:23.720093},r=14);n=new google.maps.Map(document.getElementById("map_canvas"),{center:i,zoom:r},{mapTypeId:"roadmap"});n.setTilt(45);n.addListener("idle",function(){let t=n.getCenter(),i=n.getZoom();sessionStorage.setItem("lastCenter",JSON.stringify({center:t,zoom:i}))});$("#SearchThisArea").on("click",function(){for(var t=0;t<markers.length;t++)markers[t].setMap(null);markers=[];makeTheCall(n,n.getBounds(),markers)});$("#presentLocation").on("click",function(){findMe(n)})}function makeTheCall(n,t,i){var r=t.getNorthEast(),u=t.getSouthWest();let f={latTopRight:r.lat().toFixed(6),lonTopRight:r.lng().toFixed(6),latBotLeft:u.lat().toFixed(6),lonBotLeft:u.lng().toFixed(6)};console.log("MapFrame:");console.log(f);$.ajax({url:"/MapPage/SearchThisArea",method:"post",data:f,success:function(t){RefreshMap(n,t,i);RefreshLocalsList(t)}})}function RefreshMap(n,t,i){var s=[],r,l,a;for(console.log("Returned users:"),r=0;r<t.length;r++){console.log(t[r]);animsource=t[r].avatar;anim='<span id="move"><img src="\\img\\Avatars\\'+t[r].avatar+'" class="avatar avatar-image rounded-circle img-fluid" alt="Avatar"/><\/span>';let n;n=t[r].id==meId?['<div class= "info_content">                                    <div style="width=20%"><h3><a data-id="'+t[r].id+'" onclick="GoToProfile(this);">'+t[r].userNameStr+"<\/a><\/h3><p>Average rating "+t[r].overallRating+"(from "+t[r].receivedRatingsCount+' )<\/p><\/div><br><hr>                 <div style="20%"><img src="\\img\\Avatars\\'+t[r].avatar+'" class="avatar avatar-image rounded-circle img-fluid" /><\/div >                      <\/div > ']:['<div class= "info_content">                                    <div style="width=20%"><h3><a data-id="'+t[r].id+'" title="Visit Profile" onclick="GoToProfile(this);">'+t[r].userNameStr+"<\/a><\/h3><p> Rating "+t[r].overallRating+"("+t[r].receivedRatingsCount+')<\/p><\/div><br><hr>                     <div id="info-avatar" style="20%"><img src="\\img\\Avatars\\'+t[r].avatar+'" class="avatar avatar-image rounded-circle img-fluid" /><a id="but" onclick="mvsanimation(this)" title="Send Message Now!" class= "btn btn-outline-danger btn-sm chat-with-me"  data-avatar="'+t[r].avatar+'" data-name="'+t[r].userNameStr+'" data-id="'+t[r].id+'" > Chat<\/a ><\/div >                      <\/div > '];s.push(n)}var u=new google.maps.InfoWindow,f="/img/application-images/",e={me:{url:f+"me.png",size:new google.maps.Size(31,85),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(25,75)},visitor:{url:f+"localee.png",size:new google.maps.Size(31,85),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(25,75)},localea:{url:f+"localee.png",size:new google.maps.Size(31,85),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(25,75)},admin:{url:f+"admin.png",size:new google.maps.Size(31,85),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(25,65)},localee1:{url:f+"localee1.png",size:new google.maps.Size(31,90),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(31,90)}},h=0,o=0,c=0;for(r=0;r<=t.length-1;r++)t[r].overallRating==null||t[r].receivedRatingsCount==null?o=0:(o=t[r].overallRating*8+t[r].receivedRatingsCount*2,o>h&&(h=o,c=t[r].id));for(r=0;r<t.length;r++)a=new google.maps.LatLng(parseFloat(t[r].lat),parseFloat(t[r].lon)),l=t[r].id==meId?e.me:t[r].id==c?e.localee1:t[r].localee=="admin"?e.admin:t[r].localee=="localee"?e.localea:e.localea,marker=new google.maps.Marker({position:a,map:n,title:t[r].UserNameStr,icon:l,markerId:t[r].id}),i.push(marker),google.maps.event.addListener(marker,"click",function(t,i){return function(){u.setContent(s[i][0]);u.open(n,t)}}(marker,r)),google.maps.event.addListener(marker,"click",function(t,i){return function(){u.setContent(s[i][0]);u.open(n,t)}}(marker,r)),google.maps.event.addListener(n,"click",function(){u.close()})}function RefreshLocalsList(n){$("#LocalsList").empty();for(let t=0;t<n.length;t++){let i=$("#local-template").children(":first")[0].cloneNode(!0);$(i).attr("local-id",n[t].id);$(i).find("#local-name").text(n[t].userNameStr);$(i).find("#local-avatar").attr("src","\\img\\Avatars\\"+n[t].avatar);$(i).appendTo("#LocalsList");$(i).click(function(){for(let n=0;n<markers.length;n++)if(markers[n].markerId==$(this).attr("local-id")){google.maps.event.trigger(markers[n],"click");break}})}}function mvsanimation(n){var i=$("#chating-with-avatar").offset().left,r=$("#chating-with-avatar").offset().top,u=$("#info-avatar").offset().left,f=$("#info-avatar").offset().top,t,e,o;console.log(`From (${u},${f}) to (${i},${r})`);t=document.createElement("div");e=$(n).prev().clone();t.id="moveDiv";$(t).append(e);t.style.position="absolute";t.style.width="100px";t.style.height="100px";t.style.left=u+"px";t.style.top=f+"px";t.style.zIndex=2e4;document.body.appendChild(t);o=document.getElementById("row");$("#moveDiv").animate({left:i+8,top:r+5},2e3,"swing",function(){$("#moveDiv").fadeOut("slow",function(){$("#moveDiv").remove()})})}function findMe(n){function t(t,i,r){i.setPosition(r);i.setContent(t?"Error: The Geolocation service failed.":"Error: Your browser doesn't support geolocation.");i.open(n)}let i=new google.maps.Marker({clickable:!1,icon:new google.maps.MarkerImage("//maps.gstatic.com/mapfiles/mobile/mobileimgs2.png",new google.maps.Size(22,22),new google.maps.Point(0,18),new google.maps.Point(11,11)),shadow:null,zIndex:999,map:n});navigator.geolocation?navigator.geolocation.getCurrentPosition(function(t){var r={lat:t.coords.latitude,lng:t.coords.longitude};i.setPosition(r);n.setZoom(16);n.setCenter(r)},function(){t(!0,infoWindow,n.getCenter())}):t(!1,infoWindow,n.getCenter())}function urldecode(n){return decodeURIComponent((n+"").replace(/\+/g,"%20"))}function GoToProfile(n){let t=$(n).attr("data-id"),i=$('meta[id="message"]').attr("me-id");t==i?window.open("../Manage/Index"):window.open("../Manage/VisitorView/?id="+t)}var markers=[],meId=$('meta[id="message"]').attr("me-id"),anim,animsource;$(window).ready(function(){initialize()});